<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mitch Rudge">
<meta name="dcterms.date" content="2022-02-24">

<title>Geospatial Community - Basic Raster Analysis with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../turkeypin.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Geospatial Community</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../workshops.html" rel="" target="">
 <span class="menu-text">Workshops</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/geocommunity/geocommunity_blog" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Basic Raster Analysis with R</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">spatial</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">terra</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Mitch Rudge </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#this-is-post-is-associated-with-a-workshop-that-was-held-on-the-24th-feb-2022" id="toc-this-is-post-is-associated-with-a-workshop-that-was-held-on-the-24th-feb-2022" class="nav-link active" data-scroll-target="#this-is-post-is-associated-with-a-workshop-that-was-held-on-the-24th-feb-2022">This is post is associated with a workshop that was held on the 24th Feb 2022</a></li>
  <li><a href="#what-we-will-cover" id="toc-what-we-will-cover" class="nav-link" data-scroll-target="#what-we-will-cover">What we will cover:</a></li>
  <li><a href="#raster-and-vector-basics" id="toc-raster-and-vector-basics" class="nav-link" data-scroll-target="#raster-and-vector-basics">1. Raster and vector basics</a></li>
  <li><a href="#introducing-the-terra-package" id="toc-introducing-the-terra-package" class="nav-link" data-scroll-target="#introducing-the-terra-package">2. Introducing the Terra package</a></li>
  <li><a href="#creating-importing-and-exporting-rasters" id="toc-creating-importing-and-exporting-rasters" class="nav-link" data-scroll-target="#creating-importing-and-exporting-rasters">3. Creating, Importing and exporting rasters</a></li>
  <li><a href="#dealing-with-coordinate-reference-systems" id="toc-dealing-with-coordinate-reference-systems" class="nav-link" data-scroll-target="#dealing-with-coordinate-reference-systems">4. Dealing with coordinate reference systems</a></li>
  <li><a href="#naming-and-subsetting-spatraster-layers" id="toc-naming-and-subsetting-spatraster-layers" class="nav-link" data-scroll-target="#naming-and-subsetting-spatraster-layers">5. Naming and subsetting SpatRaster layers</a></li>
  <li><a href="#raster-summaries" id="toc-raster-summaries" class="nav-link" data-scroll-target="#raster-summaries">6. Raster summaries</a></li>
  <li><a href="#raster-data-manipulation" id="toc-raster-data-manipulation" class="nav-link" data-scroll-target="#raster-data-manipulation">7. Raster data manipulation</a>
  <ul class="collapse">
  <li><a href="#aggregate-and-resample" id="toc-aggregate-and-resample" class="nav-link" data-scroll-target="#aggregate-and-resample">Aggregate and Resample</a></li>
  <li><a href="#crop" id="toc-crop" class="nav-link" data-scroll-target="#crop">Crop</a></li>
  <li><a href="#mask" id="toc-mask" class="nav-link" data-scroll-target="#mask">Mask</a></li>
  <li><a href="#stretch" id="toc-stretch" class="nav-link" data-scroll-target="#stretch">Stretch</a></li>
  <li><a href="#focal" id="toc-focal" class="nav-link" data-scroll-target="#focal">Focal</a></li>
  </ul></li>
  <li><a href="#compatibility-between-raster-and-terra" id="toc-compatibility-between-raster-and-terra" class="nav-link" data-scroll-target="#compatibility-between-raster-and-terra">8. Compatibility between Raster and Terra</a></li>
  <li><a href="#options-to-allow-the-processing-of-large-files" id="toc-options-to-allow-the-processing-of-large-files" class="nav-link" data-scroll-target="#options-to-allow-the-processing-of-large-files">9. Options to allow the processing of large files</a></li>
  <li><a href="#a-real-world-example-with-drone-data" id="toc-a-real-world-example-with-drone-data" class="nav-link" data-scroll-target="#a-real-world-example-with-drone-data">10. A real world example with drone data</a></li>
  <li><a href="#a-fun-new-package-called-layer" id="toc-a-fun-new-package-called-layer" class="nav-link" data-scroll-target="#a-fun-new-package-called-layer">11. A fun new package called Layer</a></li>
  <li><a href="#about-the-author" id="toc-about-the-author" class="nav-link" data-scroll-target="#about-the-author">About the author</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><strong>Presented by Mitch Rudge</strong><br>
PhD Candidate, UQ Sustainable Minerals Institute<br>
Twitter: <a href="https://twitter.com/mitchrudge"><img src="https://img.shields.io/twitter/url/https/twitter.com/bukotsunikki.svg?style=social&amp;label=Follow%20%2540mitchrudge" class="img-fluid" alt="Twitter URL"></a></p>
<section id="this-is-post-is-associated-with-a-workshop-that-was-held-on-the-24th-feb-2022" class="level3">
<h3 class="anchored" data-anchor-id="this-is-post-is-associated-with-a-workshop-that-was-held-on-the-24th-feb-2022">This is post is associated with a workshop that was held on the 24th Feb 2022</h3>
<p><strong>Workshop description</strong> Mitch walked through the basics of raster analysis using R. In particular, he focused on the relatively new <a href="https://github.com/rspatial/terra">Terra</a> package, which is set to replace the extremely popular <a href="https://github.com/rspatial/raster">Raster</a> package. A basic understanding of R will help, but the workshop will be aimed at beginners with no prior knowledge.</p>
</section>
<section id="what-we-will-cover" class="level2">
<h2 class="anchored" data-anchor-id="what-we-will-cover">What we will cover:</h2>
<ol type="1">
<li>Raster and vector basics</li>
<li>Introducing the Terra package</li>
<li>Creating, Importing and exporting rasters</li>
<li>Dealing with coordinate reference systems</li>
<li>Naming and sub-setting SpatRaster layers</li>
<li>Raster summaries</li>
<li>Raster data manipulation</li>
<li>Compatibility between Raster and Terra</li>
<li>Options to allow the processing of large files</li>
<li>A real world example with drone data</li>
<li>A fun new package called Layer</li>
</ol>
<p>You will need installations of R, RStudio and Terra.</p>
</section>
<section id="raster-and-vector-basics" class="level2">
<h2 class="anchored" data-anchor-id="raster-and-vector-basics">1. Raster and vector basics</h2>
<p><strong>Rasters</strong> divide areas into a grid of rectangles of equal size. Each rectangle holds one or more value for a variable of interest.</p>
<p><strong>Vectors</strong> consist of a series of coordinates that make points, lines or polygons.</p>
<p><img src="https://gsp.humboldt.edu/olm/Lessons/GIS/08%20Rasters/Images/convertingdatamodels2.png" class="img-fluid" alt="Raster vs vector credit: http://gsp.humboldt.edu/"> http://gsp.humboldt.edu/</p>
</section>
<section id="introducing-the-terra-package" class="level2">
<h2 class="anchored" data-anchor-id="introducing-the-terra-package">2. Introducing the Terra package</h2>
<p><img src="https://raw.githubusercontent.com/rspatial/terra/master/man/figures/logo.png" width="250"></p>
<p>Terra is set to replace the extremely popular Raster package. It is written by the same group of developers at <a href="https://github.com/rspatial">r spatial</a>, led by Robert Hijmans. This means that Terra is compatible with Raster - with some serious advantages.</p>
<p><strong>Advantages</strong> of Terra over Raster. It’s faster - unlike <code>Raster</code>, <code>Terra</code> is mostly written in C++, making it much faster for many operations.</p>
<p>It’s simpler - <code>Terra</code> does away with the complex data structure of <code>Raster</code> like <code>RasterLayer</code>, <code>RasterStack</code> and <code>RasterBrick</code>. We will go into this later.</p>
<p>For now, lets install and load Terra.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"terra"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-importing-and-exporting-rasters" class="level2">
<h2 class="anchored" data-anchor-id="creating-importing-and-exporting-rasters">3. Creating, Importing and exporting rasters</h2>
<p>The following examples are largely based on examples from the official <a href="https://cran.r-project.org/web/packages/terra/index.html">manual</a></p>
<p>The <code>rast()</code> function is used to create and import <code>SpatRasters</code>.</p>
<p>To create a SpatRaster from scratch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows=</span><span class="dv">108</span>, <span class="at">ncols=</span><span class="dv">108</span>, <span class="at">xmin=</span><span class="dv">0</span>, <span class="at">xmax=</span><span class="dv">10</span>, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">10</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(x) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncell</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And, probably more useful, to import a raster from a file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"ex/meuse.tif"</span>, <span class="at">package=</span><span class="st">"terra"</span>) <span class="co">#example data within terra</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But instead of <code>system.file()</code> (which is looking inside the <code>terra</code> package), point directly to a raster file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To write a <code>SpatRaster</code> to file, we can use the the <code>writeRaster</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">writeRaster</span>(r, <span class="st">"output.tif"</span>, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dealing-with-coordinate-reference-systems" class="level2">
<h2 class="anchored" data-anchor-id="dealing-with-coordinate-reference-systems">4. Dealing with coordinate reference systems</h2>
<p>Getting the coordinate reference systems correct is a very important, and sometimes tricky, aspect of geospatial analysis.</p>
<p>There are two main classes of coordinate reference systems, have a look <a href="https://rspatial.org/terra/spatial/6-crs.html">here</a> for a pretty good.</p>
<p>Angular coordinate reference systems - these represent the vertical and horizontal angles between the point on the surface and the center of the earth (see figure).</p>
<p><img src="https://rspatial.org/terra/_images/sphere.png" class="img-fluid"> Image reference: https://rspatial.org/terra/</p>
<p>To get location using an angular CRS, we require a pair of coordinates and a reference datum; a model of the shape of the earth. WGS84 is probably the most widely used global datum, where GDA94 / 2020 are commonly used Australian datums.</p>
<p>Projected coordinate reference system - here, angular coordinates have been converted to a Cartesian system, making it is easier to make maps and calculate area etc. These require a projection, a datum and a set of parameters. Projections include Mercator, UTM and Lambert.</p>
<p><strong>Defining a CRS in Terra</strong></p>
<p>Terra recommends using the EPSG database, as PROJ.4 is no longer fully supported.</p>
<p>To look up an EPSG code, go to https://epsg.org/ and find your CRS.</p>
<p>When you know the EPSG code associated with your data, you can assign it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(x) <span class="ot">&lt;-</span> <span class="st">"EPSG:27561"</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Be careful, this defines the CRS but doesn’t change the underlying data. It is not generally recommended that you project raster data because it results in a loss of precision.</p>
</section>
<section id="naming-and-subsetting-spatraster-layers" class="level2">
<h2 class="anchored" data-anchor-id="naming-and-subsetting-spatraster-layers">5. Naming and subsetting SpatRaster layers</h2>
<p>Naming the layers of a SpatRaster is pretty straightforward, using the <code>names()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">system.file</span>(<span class="st">"ex/logo.tif"</span>, <span class="at">package=</span><span class="st">"terra"</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "red"   "green" "blue" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(s) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a" "b" "c"</code></pre>
</div>
</div>
<p>Sub-setting the layers of a <code>SpatRaster</code> is also a pretty simple operation.</p>
<p>You can either use square bracket notation <code>[]</code>, the <code>subset()</code> function, or <code>$</code> notation.</p>
<p>From the <a href="https://cran.r-project.org/web/packages/terra/terra.pdf">manual</a>, here is an example using the R logo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(s, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>) <span class="co">#will select band 2 and 3</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#because we changed the names from red, green, blue to a, b c. </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>s[[<span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>)]] <span class="co">#will also select band 2 and 3</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>a <span class="co">#will select the a (red) band</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that unlike with Raster, there is no need for different classes like Raster stacks/layers/bricks.</p>
</section>
<section id="raster-summaries" class="level2">
<h2 class="anchored" data-anchor-id="raster-summaries">6. Raster summaries</h2>
<p>Now that we know how to import a Raster, define its CRS, and select the bands we are interested in, its a good time to start investigating its values.</p>
<p>The <code>global()</code> function can be used to extract values like the average, mean and max cell values. Using the elevation data we imported earlier, we could work out the highest cell on the map with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>max_h <span class="ot">&lt;-</span> <span class="fu">global</span>(r, <span class="st">"max"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>max_h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      max
test 1736</code></pre>
</div>
</div>
<p>The humble histogram is another useful tool when getting a handle on raster data. Terra allows you to create a frequency distribution histogram with <code>hist()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Or if a boxplot is more your style, you can use <code>boxplot()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/boxplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="raster-data-manipulation" class="level2">
<h2 class="anchored" data-anchor-id="raster-data-manipulation">7. Raster data manipulation</h2>
<p>There are a huge number of functions within Terra for data manipulation, but here are a few that might be useful. ### Extend and trim Often, we will find a lot of white space consisting of NA’s around our Raster. To remove this, we can use the <code>trim()</code> function. Conversely, to add white space to a raster (say, to match the extent of another Raster), we can run the <code>extend()</code> function.</p>
<p>To demonstrate this functionality, we will first add a lot of white space to our elevation raster using <code>extend</code>, before removing it with <code>trim</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>extended <span class="ot">&lt;-</span> <span class="fu">extend</span>(r, <span class="dv">50</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>trimmed <span class="ot">&lt;-</span> <span class="fu">trim</span>(extended)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="aggregate-and-resample" class="level3">
<h3 class="anchored" data-anchor-id="aggregate-and-resample">Aggregate and Resample</h3>
<p>These are used to change the resolution of a <code>SpatRaster</code>.</p>
<p>Aggregate creates a new <code>SpatRaster</code> with a lower resolution. Users need to provide the factor by which the raster will be reduced.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>agg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(r, <span class="at">fact =</span> <span class="dv">5</span>, <span class="at">fun =</span> <span class="st">'mean'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(agg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/aggregate-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can see that the resolution has been reduced, by a factor of five in this case.</p>
<p>In reality, we will often need to combine rasters from different sources that have different origins and resolutions; this will require us to match the resolution, the origin and the extent. For this, the resample function is the way to go. To demonstrate this, we can first change the origin of the raster we just aggregated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">origin</span>(agg) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">10.5</span>, <span class="fl">10.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can resample the original raster, <code>r</code>, using the new <code>agg</code> raster with different resolution and origin.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>rsm <span class="ot">&lt;-</span> <span class="fu">resample</span>(r, agg, <span class="at">method=</span> <span class="st">'bilinear'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="crop" class="level3">
<h3 class="anchored" data-anchor-id="crop">Crop</h3>
<p>Cropping is one of the most widely used operations when working with Raster data. To demonstrate a simple crop, we will need to use a <code>SpatVector</code>: the other major data class used by Terra.</p>
<p>On the data set we have been working on, we will first use the <code>spatSample()</code> function, another handy tool.</p>
<p>Here, we will randomly generate one point on the elevation raster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>samp <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(r, <span class="dv">1</span>, <span class="at">as.points=</span><span class="cn">TRUE</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can make a buffer centered on this point using the <code>buffer()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>buf <span class="ot">&lt;-</span> <span class="fu">buffer</span>(samp, <span class="at">width =</span> <span class="dv">200</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(samp, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(buf, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/crop_example1.PNG" class="img-fluid"></p>
<p>Now we can crop the elevation raster to the buffered area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cropped <span class="ot">&lt;-</span> <span class="fu">crop</span>(r, buf)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cropped)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/crop_example_2.PNG" class="img-fluid"></p>
</section>
<section id="mask" class="level3">
<h3 class="anchored" data-anchor-id="mask">Mask</h3>
<p>Notice that the buffer was a circle, but the cropped area is square. Why? Because the crop command uses the extent of the object which is always a rectangle. If you wanted to maintain the shape of the buffer, you will want to use <code>mask()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> <span class="fu">mask</span>(r, buf)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> <span class="fu">trim</span>(mask) <span class="co">#we can trim down all the NA values using the trim function</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/maskandtrim.PNG" class="img-fluid"></p>
</section>
<section id="stretch" class="level3">
<h3 class="anchored" data-anchor-id="stretch">Stretch</h3>
<p>Another task is to stretch values to a given range. For example, classification can require data that is normalised to 8bit (0-255). This can be handy if you want to normalise rasters on different scales, such as elevation in m AGL and reflectance in DN.</p>
<p>In terra, this is as easy as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>str <span class="ot">&lt;-</span> <span class="fu">stretch</span>(r) <span class="co">#defaults to 0-255</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">global</span>(str, <span class="st">"range"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     range max
test     0 255</code></pre>
</div>
</div>
</section>
<section id="focal" class="level3">
<h3 class="anchored" data-anchor-id="focal">Focal</h3>
<p>The <code>focal()</code> function can be used to clean and smooth rasters. <code>Focal()</code> uses a moving window with size <code>w</code> and a function to average neighboring cells. Lets do that with the elevation dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">focal</span>(r, <span class="at">w=</span><span class="dv">5</span>, <span class="at">fun=</span><span class="st">"mean"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="compatibility-between-raster-and-terra" class="level2">
<h2 class="anchored" data-anchor-id="compatibility-between-raster-and-terra">8. Compatibility between Raster and Terra</h2>
<p>If you have grow acustomed to using <code>Raster</code>, don’t worry, it is not difficult switch between Raster classes (RasterLayer, RasterStack etc) and SpatRaster using the <code>rast()</code> function.</p>
<p>Here is an example.</p>
<p>First install the Raster packages, which is available on CRAN.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"raster"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, using the sample data loaded into Raster, we can create a Raster stack of the r logo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>stac <span class="ot">&lt;-</span> <span class="fu">stack</span>(<span class="fu">system.file</span>(<span class="st">"ex/logo.tif"</span>, <span class="at">package=</span><span class="st">"terra"</span>)) <span class="co">#This is a raster stack</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>rst <span class="ot">&lt;-</span> <span class="fu">rast</span>(stac) <span class="co">#now this is a SpatRaster</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Its that simple. And to change this back to a <code>Raster</code> object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>stac <span class="ot">&lt;-</span> <span class="fu">raster</span>(rst) <span class="co">#now this is a RasterStack</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="options-to-allow-the-processing-of-large-files" class="level2">
<h2 class="anchored" data-anchor-id="options-to-allow-the-processing-of-large-files">9. Options to allow the processing of large files</h2>
<p>Terra has some settable options that can help to improve performance. Have a look through them with <code>?terraOptions</code></p>
<p>Particularly useful options include <code>tempdir</code>, which provides a default location for files to be written. This can help prevent your C drive being clogged with temp files.</p>
<p>Also handy is <code>memfrac</code>, which lets us stipulate how much RAM <code>terra</code> is can use - from 0-0.9.</p>
<p>Check the current options with <code>terraOptions()</code></p>
<p>Set options using <code>terraOptions(memfrac=0.2, tempdir = "C:/temp/terrafiles")</code>.</p>
</section>
<section id="a-real-world-example-with-drone-data" class="level2">
<h2 class="anchored" data-anchor-id="a-real-world-example-with-drone-data">10. A real world example with drone data</h2>
<p>In this example, we will use some of my drone data collected from savanna woodlands in north Australia.This is a typical example where we have an orthomosaic, which was derived from a camera (RGB), and a canopy height model, which was derived from LiDAR point cloud.</p>
<p>First, we need to reduce the size of the orthomosaic (1.3+ GB is too big). But in reality, we might want that much resolution depending on what we are trying to do.</p>
<p>You don’t need to run the below code, but this is what I did to reduce down the large orthomosaic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>orthopath <span class="ot">&lt;-</span> <span class="st">".../hacky_sac/2022-02-23 Basic raster analysis with R/plot1_ortho.tif"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>ortho_reduced_path <span class="ot">&lt;-</span> <span class="st">"...2022-02-23 Basic raster analysis with R/plot1_ortho_reduced.tif"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>ortho <span class="ot">&lt;-</span> <span class="fu">rast</span>(orthopath)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">res</span>(ortho) <span class="co">#check the resolution </span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#now lets reduce it down with aggregate </span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#note the filename variable lets us write directly to file</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(ortho, <span class="at">fact =</span> <span class="dv">10</span>, <span class="at">fun =</span> <span class="st">'mean'</span>, <span class="at">filename =</span> ortho_reduced_path)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>ortho_reduced <span class="ot">&lt;-</span> <span class="fu">rast</span>(ortho_reduced_path)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">res</span>(ortho_reduced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Download the reduced orthomosaic <a href="https://drive.google.com/file/d/1k0xW1VQS3QE41hm200vJUC2SbMbf6RGs/view?usp=sharing">here</a></p>
<p>And the chm <a href="https://drive.google.com/file/d/1qoKeXKwTy0ohMQZWfweW4TAj4WV22g05/view?usp=sharing">here</a></p>
<p>The first thing to do is load the .tifs as <code>SpatRasters</code> in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>homefolder <span class="ot">&lt;-</span> <span class="st">"..../Downloads"</span> <span class="co">#where did you download the files to?</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>chm_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(homefolder, <span class="st">"/"</span>, <span class="st">"plot1_chm.tif"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ortho_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(homefolder, <span class="st">"/"</span>, <span class="st">"plot1_ortho_reduced.tif"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#now read in the files using terra</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>chm <span class="ot">&lt;-</span> <span class="fu">rast</span>(chm_path)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>ortho <span class="ot">&lt;-</span> <span class="fu">rast</span>(ortho_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is an example of needing to merge rasters with different geometries into a single raster. Before we can do this, we need to make sure the crs, resolution, origin and extent match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#do the crs match?</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(chm) <span class="sc">==</span> <span class="fu">crs</span>(ortho)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">#do the origins match?</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">origin</span>(chm) <span class="sc">==</span> <span class="fu">origin</span>(ortho)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">#do the resolutions match?</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">res</span>(chm) <span class="sc">==</span> <span class="fu">res</span>(ortho)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">#do the extents match?</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ext</span>(chm) <span class="sc">==</span> <span class="fu">ext</span>(ortho)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We should see that the CRS matches, but nothing else.</p>
<p>The <code>resample()</code> function can match the geometries. If we wanted to keep the higher resolution of the orthomosaic, we can run:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>chm_resampled <span class="ot">&lt;-</span> <span class="fu">resample</span>(chm, ortho, <span class="at">method =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">#now, geometry should match</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">res</span>(chm_resampled) <span class="sc">==</span> <span class="fu">res</span>(ortho)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">origin</span>(chm_resampled) <span class="sc">==</span> <span class="fu">origin</span>(ortho)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ext</span>(chm_resampled) <span class="sc">==</span> <span class="fu">ext</span>(ortho)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On the right track. lets plot them to have a look.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm_resampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/chm_nottrimmed.PNG" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ortho)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/ortho_notcropped.PNG" class="img-fluid"></p>
<p>We can see that even though they have the same extent - as enforced by the <code>resample()</code> - there are a lot of blank cells around the CHM.</p>
<p>Lets get rid of those blank (NA) cells using the <code>trim()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>chm_resampled <span class="ot">&lt;-</span> <span class="fu">trim</span>(chm_resampled)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chm_resampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/chm_resampled.PNG" class="img-fluid"></p>
<p>That’s better, now lets crop the orthomosaic using the CHM.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ortho_cropped <span class="ot">&lt;-</span> <span class="fu">crop</span>(ortho, chm_resampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now everything should match, and we can finally combine these layers into a single <code>SpatRaster</code> object. For this, you can simply concatenate the layers: c(layer1, layer2, layer3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">c</span>(ortho_cropped, chm_resampled)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/combined_1.PNG" class="img-fluid"></p>
<p>The band names don’t make a lot of sense at this point, so we can rename them using the <code>names()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(combined) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'red'</span>, <span class="st">'green'</span>, <span class="st">'blue'</span>, <span class="st">'chm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, prior to doing some analysis, we might want to stretch the chm to 8bit - so its not under-weighted compared to the RGB data. This calls for the <code>stretch()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>combined<span class="sc">$</span>chm <span class="ot">&lt;-</span> <span class="fu">stretch</span>(combined<span class="sc">$</span>chm)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/combined_final.PNG" class="img-fluid"></p>
<p>Now we have a raster stack we can work with!</p>
</section>
<section id="a-fun-new-package-called-layer" class="level2">
<h2 class="anchored" data-anchor-id="a-fun-new-package-called-layer">11. A fun new package called Layer</h2>
<p>One fun little package I stumbled on recently is called <a href="https://github.com/cran/layer"><code>layer</code></a>. It doesn’t really serve a purpose in terms of analysis, although I’ll use it to make figures that demonstrate the raster data-sets used in analysis.</p>
<p><img src="https://raw.githubusercontent.com/cran/layer/8af3637e9b6dbe0b936dbac0318797991a4e9371/man/figures/logo.svg" width="250"></p>
<p>Unfortunately, <code>Layer</code> calls for <code>Raster</code> data, but as we know, it’s easy to convert <code>Raster</code> to <code>SpatRaster</code> objects.</p>
<p>But before we get into that, lets further reduce the resolution of the <code>combined</code> <code>SpatRaster</code>, as there is a lot going on in the background of <code>Layer</code> and its pretty slow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>combined_lowres <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(combined, <span class="at">fact =</span> <span class="dv">10</span>) <span class="co">#10x less rows and columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can load the <code>layer</code> and <code>raster</code> packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"layer"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(layer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can provide the layers to <code>tilt_map</code>, then <code>plot_tilted_map</code>, to create a nice looking tilted stack that illustrates our data. Note within the <code>tilt_map</code> function, we convert the <code>SpatRaster</code> to <code>Raster</code> with the <code>raster()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tilt_map_1 <span class="ot">&lt;-</span> <span class="fu">tilt_map</span>(<span class="fu">raster</span>(combined_lowres<span class="sc">$</span>red))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>tilt_map_2 <span class="ot">&lt;-</span> <span class="fu">tilt_map</span>(<span class="fu">raster</span>(combined_lowres<span class="sc">$</span>green), <span class="at">x_shift =</span> <span class="dv">0</span>, <span class="at">y_shift =</span> <span class="dv">50</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>tilt_map_3 <span class="ot">&lt;-</span> <span class="fu">tilt_map</span>(<span class="fu">raster</span>(combined_lowres<span class="sc">$</span>blue), <span class="at">x_shift =</span> <span class="dv">0</span>, <span class="at">y_shift =</span> <span class="dv">100</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>tilt_map_4 <span class="ot">&lt;-</span> <span class="fu">tilt_map</span>(<span class="fu">raster</span>(combined_lowres<span class="sc">$</span>chm), <span class="at">x_shift =</span> <span class="dv">0</span>, <span class="at">y_shift =</span> <span class="dv">150</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>map_list <span class="ot">&lt;-</span> <span class="fu">list</span>(tilt_map_1, tilt_map_2, tilt_map_3, tilt_map_4)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_tiltedmaps</span>(map_list, </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">layer =</span> <span class="fu">c</span>(<span class="st">"value"</span>, <span class="st">"value"</span>, <span class="st">"value"</span>, <span class="st">"value"</span>),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"bilbao"</span>, <span class="st">"mako"</span>, <span class="st">"rocket"</span>, <span class="st">"turbo"</span>),</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"grey40"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/layer_output.PNG" class="img-fluid"></p>
</section>
<section id="about-the-author" class="level1">
<h1>About the author</h1>
<p>Mitch is in the final year of a PhD with the Sustainable Minerals Institute, where he surveys savanna trees with drones to inform mine-site restoration. To process and analyse drone data - LiDAR, photogrammetry, multispec - Mitch has been forced to pick up skills in geospatial analysis using R and python.</p>
<p><img src="../..\images/mitch.PNG" class="img-fluid"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://twitter.com/mitchrudge"><img src="https://img.shields.io/twitter/url/https/twitter.com/bukotsunikki.svg?style=social&amp;label=Follow%20%2540mitchrudge" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Twitter URL</figcaption>
</figure>
</div>
<p><strong>Email</strong> mitchel.rudge@uq.edu.au</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>